<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebXR AR Moon (Fixed)</title>
<style>
body { margin:0; overflow:hidden; }
#ui {
  position:fixed;
  top:10px; left:10px;
  z-index:9999;
}
#status {
  background:rgba(0,0,0,0.7);
  color:#fff;
  border-radius:6px;
  padding:8px 12px;
  font-size:14px;
}
.ar-button {
  background:rgba(0,0,0,0.85)!important;
  border:1px solid rgba(255,255,255,0.5)!important;
}
</style>
</head>

<body>
<div id="ui">
  <div id="status">AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer;
let moon, moonGroup;
let phase = 0;

const status = document.getElementById('status');

init();

function init(){
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(
    70,
    window.innerWidth / window.innerHeight,
    0.01,
    20
  );

  renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  // âœ… ARButton (í•„ìˆ˜ ì˜µì…˜ í¬í•¨)
  const arBtn = ARButton.createButton(renderer, {
    requiredFeatures: ['local-floor']
  });
  arBtn.classList.add('ar-button');
  document.body.appendChild(arBtn);

  // âœ… XR Controller (í™”ë©´ í„°ì¹˜)
  const controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.1));

  renderer.xr.addEventListener('sessionstart', ()=>{
    status.innerText = "í™”ë©´ì„ íƒ­í•˜ë©´ ë³´ë¦„ë‹¬ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤ ğŸŒ•";
  });

  renderer.xr.addEventListener('sessionend', ()=>{
    status.innerText = "AR ì¢…ë£Œë¨";
    cleanup();
  });

  renderer.setAnimationLoop(render);
}

function onSelect(){
  // âœ… ì²« íƒ­ â†’ ë‹¬ ìƒì„±
  if (phase === 0){
    createMoon();
    phase = 1;
    status.innerText = "ğŸŒ• ë…¸ë€ ë³´ë¦„ë‹¬";
  }
}

function createMoon(){
  const loader = new THREE.TextureLoader();
  moonGroup = new THREE.Group();

  const mat = new THREE.MeshStandardMaterial({
    map: loader.load('https://threejs.org/examples/textures/planets/moon_1024.jpg'),
    color: 0xfff2cc
  });

  moon = new THREE.Mesh(
    new THREE.SphereGeometry(0.15, 64, 64),
    mat
  );

  moonGroup.add(moon);

  // âœ… XR ì¹´ë©”ë¼ ê¸°ì¤€ ìœ„ì¹˜ ê³„ì‚°
  const xrCam = renderer.xr.getCamera(camera);

  const dir = new THREE.Vector3(0, 0, -1)
    .applyQuaternion(xrCam.quaternion);

  moonGroup.position
    .copy(xrCam.position)
    .add(dir.multiplyScalar(1));

  scene.add(moonGroup);
}

function render(){
  if (moonGroup){
    moonGroup.rotation.y += 0.003;
  }
  renderer.render(scene, camera);
}

function cleanup(){
  if (moonGroup) scene.remove(moonGroup);
  moonGroup = moon = null;
  phase = 0;
}
</script>
</body>
</html>
