<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebXR AR Moon + Bunny (Stable Final)</title>
<style>
body { margin:0; overflow:hidden; }
#ui {
  position:fixed;
  top:10px; left:10px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:8px;
}
#status, button {
  background:rgba(0,0,0,0.7);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 12px;
  font-size:14px;
}
.ar-button {
  background:rgba(0,0,0,0.85)!important;
  border:1px solid rgba(255,255,255,0.5)!important;
}
</style>
</head>

<body>
<div id="ui">
  <div id="status">AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>
  <button id="btnGuide">ğŸ“¸ ìº¡ì²˜/ë…¹í™” ë°©ë²• ì•ˆë‚´</button>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer;
let moon, moonGroup;
let phase = 0; // 0:none 1:full 2:eclipse 3:red
let eclipseProgress = 0;
let moonRotate = true;

let bunnySprite = null;
let bunnyAppeared = false;
let bunnyTouched = false;

let bunnyLine = null;
let drawingBunny = false;
let bunnyDrawProgress = 0;

const raycaster = new THREE.Raycaster();
const status = document.getElementById('status');
const btnGuide = document.getElementById('btnGuide');

init();

function init(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const arBtn = ARButton.createButton(renderer);
  arBtn.classList.add('ar-button');
  document.body.appendChild(arBtn);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.1));

  renderer.xr.addEventListener('sessionstart', ()=>{
    status.innerText = "í™”ë©´ ì¤‘ì•™ì„ íƒ­í•˜ë©´ ë³´ë¦„ë‹¬ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤ ğŸŒ•";
  });

  renderer.xr.addEventListener('sessionend', cleanup);

  renderer.domElement.addEventListener('click', onTap);
  renderer.setAnimationLoop(render);
}

function onTap(){
  // ì¤‘ì•™ í¬ì¸í„° ê¸°ë°˜ ray
  raycaster.setFromCamera({x:0,y:0}, camera);

  // 1ï¸âƒ£ ì²« íƒ­ â†’ ë‹¬ ìƒì„±
  if (phase === 0){
    createMoon();
    phase = 1;
    status.innerText = "ğŸŒ• ë…¸ë€ ë³´ë¦„ë‹¬";
    return;
  }

  // 2ï¸âƒ£ í™”ë©´ ì¤‘ì•™ì— ë‹¬ì´ ìˆëŠ”ì§€ ê²€ì‚¬
  const hitMoon = raycaster.intersectObject(moon);

  // â–¶ ë‹¬ì´ ì¤‘ì•™ì— ìˆìœ¼ë©´ ë‹¬ ìƒí˜¸ì‘ìš©ë§Œ
  if (hitMoon.length > 0){
    if (phase === 1){
      phase = 2;
      eclipseProgress = 0;
      moon.material.uniforms.eclipseActive.value = true;
      status.innerText = "ğŸŒ˜ ì›”ì‹";
    } else if (phase === 2){
      phase = 3;
      moon.material.uniforms.phase.value = 2.0;
      status.innerText = "ğŸŒ‘ ë¶‰ì€ ë‹¬";
    }
    return;
  }

  // â–¶ ë‹¬ì´ ì¤‘ì•™ì— ì—†ì„ ë•Œë§Œ í† ë¼ (1íšŒë§Œ)
  if (!bunnyAppeared){
    spawnBunny();
    bunnyAppeared = true;
    status.innerText = "ğŸ‡ í† ë¼ê°€ ë‚˜íƒ€ë‚¬ì–´ìš”!";
  }
}

function spawnBunny(){
  const tex = new THREE.TextureLoader().load('https://i.imgur.com/9WfhK7C.png');
  bunnySprite = new THREE.Sprite(
    new THREE.SpriteMaterial({ map: tex, transparent:true })
  );
  bunnySprite.scale.set(0.3,0.3,1);

  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  bunnySprite.position.copy(camera.position).add(dir.multiplyScalar(1));

  scene.add(bunnySprite);
}

function startBunnyLineAnimation(){
  moonRotate = false;
  moonGroup.rotation.y = 0;

  const points = [];
  const uvPath = [
    [0.55,0.55],[0.57,0.6],[0.6,0.62],[0.63,0.6],
    [0.65,0.55],[0.62,0.52],[0.58,0.52],[0.55,0.55]
  ];

  uvPath.forEach(([u,v])=>{
    const phi = (1 - v) * Math.PI;
    const theta = u * Math.PI * 2;
    const r = 0.151;
    points.push(new THREE.Vector3(
      r*Math.sin(phi)*Math.cos(theta),
      r*Math.cos(phi),
      r*Math.sin(phi)*Math.sin(theta)
    ));
  });

  const geo = new THREE.BufferGeometry().setFromPoints(points);
  geo.setDrawRange(0,0);

  bunnyLine = new THREE.Line(
    geo,
    new THREE.LineBasicMaterial({ color: 0xffffff })
  );

  moonGroup.add(bunnyLine);
  bunnyDrawProgress = 0;
  drawingBunny = true;
}

function render(){
  if (moonGroup && moonRotate) moonGroup.rotation.y += 0.003;

  // í† ë¼ í„°ì¹˜ ê°ì§€ (ì¤‘ì•™ í¬ì¸í„° ê¸°ë°˜)
  if (bunnySprite && !bunnyTouched){
    raycaster.setFromCamera({x:0,y:0}, camera);
    const hit = raycaster.intersectObject(bunnySprite);
    if (hit.length){
      bunnyTouched = true;
      scene.remove(bunnySprite);
      startBunnyLineAnimation();
    }
  }

  // í† ë¼ ì„  ì• ë‹ˆë©”ì´ì…˜
  if (drawingBunny && bunnyLine){
    bunnyDrawProgress += 0.5;
    bunnyLine.geometry.setDrawRange(0, bunnyDrawProgress);
    if (bunnyDrawProgress >= bunnyLine.geometry.attributes.position.count){
      drawingBunny = false;
      moonRotate = true;
      status.innerText = "ğŸŒ• ë‹¬ì´ ë‹¤ì‹œ íšŒì „í•©ë‹ˆë‹¤";
    }
  }

  // ì›”ì‹ ì§„í–‰
  if (phase === 2 && eclipseProgress < 1){
    eclipseProgress += 0.003;
    moon.material.uniforms.eclipse.value = eclipseProgress * 2;
  }

  renderer.render(scene, camera);
}

function createMoon(){
  const loader = new THREE.TextureLoader();
  moonGroup = new THREE.Group();

  const mat = new THREE.ShaderMaterial({
    uniforms:{
      map:{value:loader.load('https://threejs.org/examples/textures/planets/moon_1024.jpg')},
      eclipse:{value:0},
      eclipseActive:{value:false},
      phase:{value:0}
    },
    vertexShader:`
      varying vec2 vUv;
      varying vec3 vNormal;
      void main(){
        vUv=uv;
        vNormal=normalize(normalMatrix*normal);
        gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);
      }
    `,
    fragmentShader:`
      uniform sampler2D map;
      uniform float eclipse;
      uniform bool eclipseActive;
      uniform float phase;
      varying vec2 vUv;
      varying vec3 vNormal;
      void main(){
        vec3 c=texture2D(map,vUv).rgb;
        c=pow(c,vec3(0.75))*vec3(1.2,1.15,0.95);
        if(eclipseActive){
          float e=smoothstep(-1.+eclipse,-0.2+eclipse,vNormal.x);
          c*=mix(0.3,1.,e);
        }
        if(phase>1.5){
          c=vec3(c.r*1.2,c.g*0.6,c.b*0.55);
        }
        gl_FragColor=vec4(c,1.);
      }
    `
  });

  moon = new THREE.Mesh(new THREE.SphereGeometry(0.15,64,64), mat);
  moonGroup.add(moon);

  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  moonGroup.position.copy(camera.position).add(dir.multiplyScalar(1));
  scene.add(moonGroup);
}

function cleanup(){
  if (moonGroup) scene.remove(moonGroup);
  if (bunnySprite) scene.remove(bunnySprite);
  moonGroup = moon = bunnySprite = bunnyLine = null;
  phase = 0;
  bunnyAppeared = bunnyTouched = drawingBunny = false;
  status.innerText = "AR ì¢…ë£Œë¨";
}

btnGuide.onclick = ()=>{
  alert(
    "ğŸ“¸ AR í™”ë©´ ìº¡ì²˜/ë…¹í™” ì•ˆë‚´\n\n" +
    "â€¢ ìº¡ì²˜: ì „ì› + ë³¼ë¥¨ í•˜ë‹¨\n" +
    "  (ì‚¬ìš©ë²„íŠ¼ì€ ê°œì¸ì„¤ì •ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)\n" +
    "â€¢ ë…¹í™”: ìƒë‹¨ ì•Œë¦¼ì°½ â†’ í™”ë©´ ë…¹í™”\n\n" +
    "ì›¹ ARì€ ë¸Œë¼ìš°ì € í•©ì„± í™”ë©´ì´ë¯€ë¡œ\n" +
    "ì›¹ì—ì„œ ì§ì ‘ ì €ì¥ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
  );
};
</script>
</body>
</html>
