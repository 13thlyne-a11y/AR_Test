<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebXR AR Moon + Bunny</title>
<style>
body { margin:0; overflow:hidden; }

#ui{
  position:fixed;
  top:10px;
  left:10px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:8px;
}

#status, button{
  background:rgba(0,0,0,0.7);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 12px;
  font-size:14px;
}

.ar-button{
  background:rgba(0,0,0,0.85)!important;
  border:1px solid rgba(255,255,255,0.5)!important;
}
</style>
</head>

<body>

<div id="ui">
  <div id="status">ì´ˆê¸°í™” ì¤‘...</div>
  <button id="btnGuide">ğŸ“¸ ìº¡ì²˜/ë…¹í™” ë°©ë²• ì•ˆë‚´</button>
</div>

<script type="module">

import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer;
let moon, moonGroup;
let bunnySprite=null;
let bunnyLine=null;

let phase=0;
let eclipseProgress=0;

let particles=[];
let raycaster=new THREE.Raycaster();
let lastPointer={x:0,y:0,time:0};

let moonTouchedOnce=false;   // ë‹¬ì„ íƒ­í–ˆëŠ”ì§€ ì²´í¬
let moonTouchedTwice=false;  // ì›”ì‹ ì´í›„ ë‹¬ì„ ë‹¤ì‹œ íƒ­í–ˆëŠ”ì§€ ì²´í¬

const status=document.getElementById("status");
const btnGuide=document.getElementById("btnGuide");

init();

async function init(){
  try {
    scene=new THREE.Scene();
    camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.01,20);

    renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.xr.enabled=true;
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.2));

    renderer.domElement.addEventListener('pointerup', e=>{
      lastPointer.x=e.clientX;
      lastPointer.y=e.clientY;
      lastPointer.time=performance.now();
    });

    const controller=renderer.xr.getController(0);
    controller.addEventListener("select", onSelect);
    scene.add(controller);

    if(!navigator.xr){
      status.innerText="âŒ WebXR ë¯¸ì§€ì› ë¸Œë¼ìš°ì €";
      return;
    }

    const supported = await navigator.xr.isSessionSupported('immersive-ar');
    if(!supported){
      status.innerText="âŒ immersive-ar ë¯¸ì§€ì› ê¸°ê¸°";
      return;
    }

    status.innerText="AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.";

    const btn=ARButton.createButton(renderer,{
      optionalFeatures:['local-floor','hit-test']
    });
    btn.classList.add("ar-button");
    document.body.appendChild(btn);

    renderer.xr.addEventListener("sessionstart",()=>{
      status.innerText="í™”ë©´ì„ íƒ­í•˜ë©´ ë³´ë¦„ë‹¬ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤ ğŸŒ•";
    });

    renderer.xr.addEventListener("sessionend", resetScene);

    renderer.setAnimationLoop(render);

  } catch (e) {
    console.error(e);
    status.innerText="âŒ ì´ˆê¸°í™” ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)";
  }
}

function resetScene(){
  if(moonGroup) scene.remove(moonGroup);
  if(bunnySprite) scene.remove(bunnySprite);
  particles.forEach(p=>scene.remove(p));

  moonGroup=null;
  moon=null;
  bunnySprite=null;
  bunnyLine=null;
  particles=[];
  phase=0;
  eclipseProgress=0;

  moonTouchedOnce=false;
  moonTouchedTwice=false;

  status.innerText="AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.";
}

function onSelect(){

  // 1) ì²˜ìŒ í™”ë©´ íƒ­í•˜ë©´ ë‹¬ ìƒì„± (ì–´ëŠ ìœ„ì¹˜ë“  OK)
  if(phase===0){
    createMoon();
    spawnBunny();
    phase=1;
    status.innerText="ğŸŒ• ë‹¬ê³¼ í† ë¼ê°€ ë‚˜íƒ€ë‚¬ì–´ìš”!";
    return;
  }

  // ì´í›„ë¶€í„°ëŠ” ë‹¬ì„ íƒ­í–ˆì„ ë•Œë§Œ ë°˜ì‘í•˜ë„ë¡ ì²˜ë¦¬
  const now=performance.now();
  const usePointer=(now-lastPointer.time<200);
  const x=usePointer?(lastPointer.x/window.innerWidth)*2-1:0;
  const y=usePointer?-(lastPointer.y/window.innerHeight)*2+1:0;

  raycaster.setFromCamera({x,y},camera);

  // í† ë¼ í„°ì¹˜
  if(bunnySprite && raycaster.intersectObject(bunnySprite).length){
    scene.remove(bunnySprite);
    bunnySprite=null;
    drawBunnyOnMoon();
    status.innerText="ğŸ‡ ë‹¬ì— í† ë¼ê°€ ê·¸ë ¤ì¡Œì–´ìš”!";
    return;
  }

  // ë‹¬ í„°ì¹˜ë§Œ ë°˜ì‘í•˜ë„ë¡ ì²˜ë¦¬
  const moonHit = moon && raycaster.intersectObject(moon).length;

  if(!moonHit) return;

  // ë‹¬ í„°ì¹˜ 1íšŒ -> ì›”ì‹ ì‹œì‘
  if(phase===1 && !moonTouchedOnce){
    moonTouchedOnce=true;
    createParticles(moonGroup.position); // íŒŒí‹°í´ 1íšŒ ë°œìƒ
    phase=2;
    eclipseProgress=0;
    moon.material.uniforms.eclipseActive.value=true;
    status.innerText="ğŸŒ˜ ì›”ì‹ ì‹œì‘!";
    return;
  }

  // ë‹¬ í„°ì¹˜ 2íšŒ -> ë¶‰ì€ ë‹¬
  if(phase===2 && moonTouchedOnce && !moonTouchedTwice){
    moonTouchedTwice=true;
    createParticles(moonGroup.position); // íŒŒí‹°í´ 1íšŒ ë°œìƒ
    phase=3;
    moon.material.uniforms.phase.value=2.0;
    status.innerText="ğŸŒ‘ ë¶‰ì€ ë‹¬!";
    return;
  }
}

function createMoon(){
  const loader=new THREE.TextureLoader();
  moonGroup=new THREE.Group();

  const mat=new THREE.ShaderMaterial({
    uniforms:{
      map:{value:loader.load('https://threejs.org/examples/textures/planets/moon_1024.jpg')},
      eclipse:{value:0},
      eclipseActive:{value:false},
      phase:{value:0}
    },
    vertexShader:`
      varying vec2 vUv;
      varying vec3 vNormal;
      void main(){
        vUv=uv;
        vNormal=normalize(normalMatrix*normal);
        gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);
      }
    `,
    fragmentShader:`
      uniform sampler2D map;
      uniform float eclipse;
      uniform bool eclipseActive;
      uniform float phase;
      varying vec2 vUv;
      varying vec3 vNormal;
      void main(){
        vec3 c=texture2D(map,vUv).rgb;
        c=pow(c,vec3(0.75))*vec3(1.2,1.15,0.95);
        if(eclipseActive){
          float e=smoothstep(-1.+eclipse,-0.2+eclipse,vNormal.x);
          c*=mix(0.3,1.,e);
        }
        if(phase>1.5){
          c=vec3(c.r*1.2,c.g*0.6,c.b*0.55);
        }
        gl_FragColor=vec4(c,1.);
      }
    `
  });

  moon=new THREE.Mesh(new THREE.SphereGeometry(0.15,64,64),mat);
  moonGroup.add(moon);

  const cam=renderer.xr.getCamera(camera);
  const dir=new THREE.Vector3(0,0,-1).applyQuaternion(cam.quaternion);
  moonGroup.position.copy(cam.position).add(dir.multiplyScalar(1.5));

  scene.add(moonGroup);
}

function spawnBunny(){
  const size = 256;
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext('2d');

  // íˆ¬ëª… ë°°ê²½ ìœ ì§€
  ctx.clearRect(0,0,size,size);

  // ëª¸í†µ
  ctx.fillStyle = "#ffffff";
  ctx.beginPath();
  ctx.ellipse(128,150,55,70,0,0,Math.PI*2);
  ctx.fill();

  // ì–¼êµ´
  ctx.beginPath();
  ctx.arc(128,95,45,0,Math.PI*2);
  ctx.fill();

  // ê·€
  ctx.beginPath();
  ctx.ellipse(100,35,18,55,0,0,Math.PI*2);
  ctx.ellipse(156,35,18,55,0,0,Math.PI*2);
  ctx.fill();

  // ê·€ ì•ˆìª½
  ctx.fillStyle="#ffb6c1";
  ctx.beginPath();
  ctx.ellipse(100,40,8,35,0,0,Math.PI*2);
  ctx.ellipse(156,40,8,35,0,0,Math.PI*2);
  ctx.fill();

  // ëˆˆ
  ctx.fillStyle="#000000";
  ctx.beginPath();
  ctx.arc(112,90,5,0,Math.PI*2);
  ctx.arc(144,90,5,0,Math.PI*2);
  ctx.fill();

  // ì½”
  ctx.fillStyle="#ff8c8c";
  ctx.beginPath();
  ctx.arc(128,105,5,0,Math.PI*2);
  ctx.fill();

  // ì…
  ctx.strokeStyle="#000000";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(128,110);
  ctx.quadraticCurveTo(118,120,110,115);
  ctx.moveTo(128,110);
  ctx.quadraticCurveTo(138,120,146,115);
  ctx.stroke();

  const texture = new THREE.CanvasTexture(canvas);

  bunnySprite = new THREE.Sprite(
    new THREE.SpriteMaterial({
      map: texture,
      transparent: true
    })
  );

  bunnySprite.scale.set(0.5,0.5,1);

  const side = Math.random()<0.5 ? -1 : 1;

  bunnySprite.position.copy(moonGroup.position)
    .add(new THREE.Vector3(side*1,0,0));

  scene.add(bunnySprite);
}

function drawBunnyOnMoon(){
  const points=[
    new THREE.Vector3(0.02,0.03,0.16),
    new THREE.Vector3(0.05,0.07,0.16),
    new THREE.Vector3(0.08,0.03,0.16),
    new THREE.Vector3(0.05,0.0,0.16),
    new THREE.Vector3(0.02,0.03,0.16)
  ];
  const geo=new THREE.BufferGeometry().setFromPoints(points);
  bunnyLine=new THREE.Line(geo,new THREE.LineBasicMaterial({color:0xffffff}));
  moonGroup.add(bunnyLine);
}

function createCircleTexture(){
  const size=64;
  const canvas=document.createElement('canvas');
  canvas.width=canvas.height=size;
  const ctx=canvas.getContext('2d');

  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(size/2, size/2, size/2, 0, Math.PI*2);
  ctx.fill();

  return new THREE.CanvasTexture(canvas);
}

function createParticles(position){
  const geometry=new THREE.BufferGeometry();
  const count=60;
  const positions=[];
  const velocities=[];

  for(let i=0;i<count;i++){
    positions.push(position.x,position.y,position.z);
    velocities.push(
      (Math.random()-0.5)*0.03,
      (Math.random()-0.5)*0.03,
      (Math.random()-0.5)*0.03
    );
  }

  geometry.setAttribute('position',
    new THREE.Float32BufferAttribute(positions,3)
  );

  const material=new THREE.PointsMaterial({
    map:createCircleTexture(),
    size:0.05,
    transparent:true,
    blending:THREE.AdditiveBlending,
    depthWrite:false
  });

  const points=new THREE.Points(geometry,material);
  points.userData={
    velocities,
    life:1,
    twinkleOffset:Math.random()*10
  };

  scene.add(points);
  particles.push(points);
}

function updateParticles(){
  const time=performance.now()*0.005;

  particles.forEach((p,i)=>{
    const pos=p.geometry.attributes.position.array;
    const vel=p.userData.velocities;

    for(let j=0;j<vel.length/3;j++){
      pos[j*3]+=vel[j*3];
      pos[j*3+1]+=vel[j*3+1];
      pos[j*3+2]+=vel[j*3+2];
    }

    p.geometry.attributes.position.needsUpdate=true;

    p.userData.life-=0.015;
    p.material.opacity=
      p.userData.life*
      (0.5+0.5*Math.sin(time+p.userData.twinkleOffset));

    if(p.userData.life<=0){
      scene.remove(p);
      particles.splice(i,1);
    }
  });
}

function render(){
  // 2) ë‹¬ ìì „ íš¨ê³¼ ì¶”ê°€
  if(moonGroup){
    moonGroup.rotation.y += 0.003; // ì²œì²œíˆ íšŒì „
  }

  // 1) ì›”ì‹ ì§„í–‰
  if(phase===2 && eclipseProgress<1){
    eclipseProgress+=0.003;
    moon.material.uniforms.eclipse.value=eclipseProgress*2;
  }

  updateParticles();
  renderer.render(scene,camera);
}

btnGuide.onclick=()=>{
  alert(
    "ğŸ“¸ AR í™”ë©´ ìº¡ì²˜/ë…¹í™” ì•ˆë‚´\n\n"+
    "â€¢ ìº¡ì²˜: ì „ì› + ë³¼ë¥¨ í•˜ë‹¨\n"+
    "  (ì‚¬ìš©ë²„íŠ¼ì€ ê°œì¸ì„¤ì •ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)\n"
    "â€¢ ë…¹í™”: ìƒë‹¨ ì•Œë¦¼ì°½ â†’ í™”ë©´ ë…¹í™”\n\n"+
    "ì›¹ ARì€ ë¸Œë¼ìš°ì € í•©ì„± í™”ë©´ì´ë¯€ë¡œ\n"+
    "ì›¹ ë‚´ë¶€ ì €ì¥ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
  );
};

</script>
</body>
</html>
