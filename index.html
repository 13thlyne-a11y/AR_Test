<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR AR ë³´ë¦„ë‹¬ (Natural Moon)</title>
  <style>
    body { margin: 0; overflow: hidden; }

    #ui {
      position: fixed;
      z-index: 9999;
      left: 10px;
      top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    button {
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: rgba(0,0,0,0.7);
      color: white;
    }

    #status {
      padding: 8px 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 6px;
      font-size: 14px;
    }

    .ar-button {
      background: rgba(0,0,0,0.85) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.5) !important;
      font-weight: 600 !important;
    }
  </style>
</head>
<body>
<div id="ui">
  <div id="status">AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>
  <button id="btnGuide">ğŸ“¸ ìº¡ì²˜/ë…¹í™” ë°©ë²• ì•ˆë‚´</button>
  <button id="btnEnd" style="display:none">âŒ AR ì¢…ë£Œ</button>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer, controller;
let moonGroup, moon, glow;

let phase = 0;
let eclipseProgress = 0;

const status = document.getElementById('status');
const btnGuide = document.getElementById('btnGuide');
const btnEnd = document.getElementById('btnEnd');

init();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const arBtn = ARButton.createButton(renderer);
  arBtn.classList.add('ar-button');
  document.body.appendChild(arBtn);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));

  controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);

  renderer.xr.addEventListener('sessionstart', () => {
    status.innerText = "í™”ë©´ì„ íƒ­í•˜ë©´ ë³´ë¦„ë‹¬ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤ ğŸŒ•";
    btnEnd.style.display = 'block';
  });

  renderer.xr.addEventListener('sessionend', cleanupMoon);
  renderer.setAnimationLoop(render);
}

function onSelect() {
  if (phase === 0) {
    createMoon();
    phase = 1;
    status.innerText = "ğŸŒ• ìì—°ìŠ¤ëŸ¬ìš´ ë³´ë¦„ë‹¬";
    return;
  }

  if (phase === 1) {
    phase = 2;
    eclipseProgress = 0;
    moon.material.uniforms.eclipseActive.value = true;
    status.innerText = "ğŸŒ˜ ì›”ì‹ì´ ì‹œì‘ë©ë‹ˆë‹¤";
    return;
  }

  if (phase === 2) {
    moon.material.uniforms.phase.value = 2.0;
    glow.material.color.set(0xffaa88);
    glow.material.opacity = 0.45;
    phase = 3;
    status.innerText = "ğŸŒ‘ ì€ì€í•œ ë¶‰ì€ ë‹¬";
  }
}

function createMoon() {
  const loader = new THREE.TextureLoader();
  moonGroup = new THREE.Group();

  const material = new THREE.ShaderMaterial({
    uniforms: {
      map: { 
        value: loader.load(
          'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/moon.jpg'
        ) 
      },
      eclipse: { value: 0.0 },
      eclipseActive: { value: false },
      phase: { value: 0.0 }
    },
    vertexShader: `
      varying vec2 vUv;
      varying vec3 vNormal;
      void main(){
        vUv = uv;
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,
    fragmentShader: `
      uniform sampler2D map;
      uniform float eclipse;
      uniform bool eclipseActive;
      uniform float phase;
      varying vec2 vUv;
      varying vec3 vNormal;

      void main(){
        vec3 base = texture2D(map, vUv).rgb;

        // ğŸŒ• ìì—°ìŠ¤ëŸ¬ìš´ ë‹¬ ìƒ‰ê°
        vec3 color = base;
        color = pow(color, vec3(0.9));
        color *= vec3(1.05, 1.05, 1.0);

        // ğŸŒ• ì•„ì£¼ ì•½í•œ ëª…ì•”ìœ¼ë¡œ ì…ì²´ê°
        float light = dot(normalize(vNormal), vec3(0.2, 0.0, 1.0));
        light = clamp(light, 0.3, 1.0);
        color *= light;

        // ğŸŒ˜ ì›”ì‹
        if (eclipseActive) {
          float edge = smoothstep(-1.0 + eclipse, -0.2 + eclipse, vNormal.x);
          color *= mix(0.3, 1.0, edge);
        }

        // ğŸŒ‘ ë¶‰ì€ ë‹¬
        if (phase > 1.5) {
          color = base * vec3(1.15, 0.65, 0.55);
        }

        gl_FragColor = vec4(color, 1.0);
      }
    `
  });

  moon = new THREE.Mesh(new THREE.SphereGeometry(0.15,64,64), material);
  moonGroup.add(moon);

  glow = new THREE.Sprite(new THREE.SpriteMaterial({
    map: loader.load('https://threejs.org/examples/textures/sprites/glow.png'),
    color: 0xffffff,
    transparent: true,
    opacity: 0.35
  }));
  glow.scale.set(0.6,0.6,1);
  moonGroup.add(glow);

  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  moonGroup.position.copy(camera.position).add(dir.multiplyScalar(1));

  scene.add(moonGroup);
}

function render() {
  if (moonGroup) {
    moonGroup.rotation.y += 0.004;

    if (phase === 2 && eclipseProgress < 1) {
      eclipseProgress += 0.003;
      moon.material.uniforms.eclipse.value = eclipseProgress * 2.0;
      glow.material.opacity = THREE.MathUtils.lerp(0.35, 0.12, eclipseProgress);
    }
  }

  renderer.render(scene, camera);
}

function cleanupMoon() {
  if (!moonGroup) return;

  moonGroup.traverse(o => {
    if (o.geometry) o.geometry.dispose();
    if (o.material) o.material.dispose();
  });

  scene.remove(moonGroup);
  moonGroup = null;
  phase = 0;
  status.innerText = "AR ì¢…ë£Œë¨";
  btnEnd.style.display = 'none';
}

btnEnd.onclick = () => {
  const session = renderer.xr.getSession();
  if (session) session.end();
};

btnGuide.onclick = () => {
  alert(
    "ğŸ“¸ AR í™”ë©´ ìº¡ì²˜/ë…¹í™” ì•ˆë‚´\n\n" +
    "â€¢ ìº¡ì²˜: ì „ì› + ë³¼ë¥¨ í•˜ë‹¨\n" +
    "  (ì‚¬ìš©ë²„íŠ¼ì€ ê°œì¸ì„¤ì •ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)\n" +
    "â€¢ ë…¹í™”: ìƒë‹¨ ì•Œë¦¼ì°½ â†’ í™”ë©´ ë…¹í™”\n\n" +
    "ì›¹ ARì€ ë¸Œë¼ìš°ì € í•©ì„± í™”ë©´ì´ë¯€ë¡œ\n" +
    "ì›¹ì—ì„œ ì§ì ‘ ì €ì¥ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
  );
};
</script>
</body>
</html>
