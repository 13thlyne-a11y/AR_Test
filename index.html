<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebXR AR Moon</title>
<style>
body { margin:0; overflow:hidden; }

#ui{
  position:fixed;
  top:10px;
  left:10px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:8px;
}

#status, button{
  background:rgba(0,0,0,0.7);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 12px;
  font-size:14px;
}

.ar-button{
  background:rgba(0,0,0,0.85)!important;
  border:1px solid rgba(255,255,255,0.5)!important;
}
</style>
</head>

<body>

<div id="ui">
  <div id="status">ì´ˆê¸°í™” ì¤‘...</div>
  <button id="btnGuide">ğŸ“¸ ìº¡ì²˜/ë…¹í™” ë°©ë²• ì•ˆë‚´</button>
</div>

<script type="module">

import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer;
let moon, moonGroup;
let bunnySprite=null;
let bunnyLine=null;
let particles=[];
let phase=0;
let eclipseProgress=0;

const status=document.getElementById("status");
const btnGuide=document.getElementById("btnGuide");

init();

function init(){

  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.01,20);

  renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.xr.enabled=true;
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.2));

  if(!navigator.xr){
    status.innerText="âŒ WebXR ë¯¸ì§€ì› ë¸Œë¼ìš°ì €";
    return;
  }

  navigator.xr.isSessionSupported('immersive-ar').then(supported=>{

    if(supported){
      status.innerText="AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.";

      const btn=ARButton.createButton(renderer,{
        optionalFeatures:['local-floor','hit-test']
      });

      btn.classList.add("ar-button");
      document.body.appendChild(btn);

    }else{
      status.innerText="âŒ immersive-ar ë¯¸ì§€ì› ê¸°ê¸°";
    }
  });

  renderer.xr.addEventListener("sessionstart",()=>{
    status.innerText="í™”ë©´ì„ íƒ­í•˜ë©´ ë‹¬ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤ ğŸŒ•";
  });

  renderer.xr.addEventListener("sessionend",resetScene);

  renderer.setAnimationLoop(render);

  window.addEventListener("click",onTap);
}

function resetScene(){
  if(moonGroup) scene.remove(moonGroup);
  if(bunnySprite) scene.remove(bunnySprite);
  particles.forEach(p=>scene.remove(p));

  moonGroup=null;
  moon=null;
  bunnySprite=null;
  particles=[];
  phase=0;
  eclipseProgress=0;

  status.innerText="AR ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.";
}

function onTap(){
  if(!renderer.xr.isPresenting) return;

  if(phase===0){
    createMoon();
    spawnBunny();
    phase=1;
    status.innerText="ğŸŒ• ë‹¬ê³¼ í† ë¼ ë“±ì¥!";
  }
}

function createMoon(){
  const loader=new THREE.TextureLoader();
  moonGroup=new THREE.Group();

  const mat=new THREE.MeshStandardMaterial({
    map:loader.load('https://threejs.org/examples/textures/planets/moon_1024.jpg')
  });

  moon=new THREE.Mesh(new THREE.SphereGeometry(0.15,64,64),mat);
  moonGroup.add(moon);

  const cam=renderer.xr.getCamera(camera);
  const dir=new THREE.Vector3(0,0,-1).applyQuaternion(cam.quaternion);
  moonGroup.position.copy(cam.position).add(dir.multiplyScalar(1.5));

  scene.add(moonGroup);
}

function spawnBunny(){
  const tex=new THREE.TextureLoader().load(
    "https://threejs.org/examples/textures/sprite.png"
  );

  bunnySprite=new THREE.Sprite(
    new THREE.SpriteMaterial({map:tex,transparent:true})
  );

  bunnySprite.scale.set(0.4,0.4,1);

  const side=Math.random()<0.5?-1:1;
  bunnySprite.position.copy(moonGroup.position)
    .add(new THREE.Vector3(side*1,0,0));

  scene.add(bunnySprite);
}

function render(){
  renderer.render(scene,camera);
}

btnGuide.onclick=()=>{
  alert(
    "ğŸ“¸ AR í™”ë©´ ìº¡ì²˜/ë…¹í™” ì•ˆë‚´\n\n"+
    "â€¢ ìº¡ì²˜: ì „ì› + ë³¼ë¥¨ í•˜ë‹¨\n"+
    "â€¢ ë…¹í™”: ìƒë‹¨ ì•Œë¦¼ì°½ â†’ í™”ë©´ ë…¹í™”\n\n"+
    "ì›¹ ARì€ ë¸Œë¼ìš°ì € í•©ì„± í™”ë©´ì´ë¯€ë¡œ\n"+
    "ì›¹ ë‚´ë¶€ ì €ì¥ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
  );
};

</script>
</body>
</html>
